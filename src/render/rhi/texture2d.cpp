/************************************************************************/
/*                                                                      */
/* INCLUDE                                                              */
/*                                                                      */
/************************************************************************/
#include "texture2d.h"

#include "render/rhi/rhidevicecontext.h"
#include "render/rhi/rhidevice.h"
#include "render/rhi/rhioutput.h"

/************************************************************************/
/*                                                                      */
/* DEFINES AND CONSTANTS                                                */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* MACROS                                                               */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* TYPES                                                                */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* STRUCTS                                                              */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* CLASSES                                                              */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* LOCAL VARIABLES                                                      */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* GLOBAL VARIABLES                                                     */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* LOCAL FUNCTIONS                                                      */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* EXTERNAL FUNCTIONS                                                   */
/*                                                                      */
/************************************************************************/
//------------------------------------------------------------------------
// TEXTURE2D
//------------------------------------------------------------------------

//------------------------------------------------------------------------
Texture2D::Texture2D( RHIDevice *owner ) 
   : device(owner)
   , dx_resource(nullptr)
   , dx_rtv(nullptr)
   // , dx_srv(nullptr)
   , width(0)
   , height(0)
   // , dx_bind_flags(0U
{}

//------------------------------------------------------------------------
// specialized for the output's texture
Texture2D::Texture2D( RHIDevice *owner, RHIOutput *output ) 
   : Texture2D( owner )
{
   if (output != nullptr) {
      ID3D11Texture2D *back_buffer = nullptr;
      output->swap_chain->GetBuffer(0, __uuidof(ID3D11Texture2D), (LPVOID*)&back_buffer);
      if (nullptr != back_buffer) {
         dx_resource = back_buffer;

         // Get info about it.
         D3D11_TEXTURE2D_DESC desc;
         dx_resource->GetDesc(&desc);

         width = desc.Width;
         height = desc.Height;
         // dx_bind_flags = desc.BindFlags

         create_views();
      }
   }
}

//------------------------------------------------------------------------
// Texture2D::Texture2D( RHIDevice *owner, char const *filename ) {}


//------------------------------------------------------------------------
Texture2D::~Texture2D()
{
   destroy();
}

//------------------------------------------------------------------------
void Texture2D::destroy()
{
   if (is_valid()) {
      DX_SAFE_RELEASE(dx_rtv);
      DX_SAFE_RELEASE(dx_resource);
   }
}

//------------------------------------------------------------------------
void Texture2D::create_views()
{
   ID3D11Device *dd = device->dx_device;
   dd->CreateRenderTargetView( dx_resource, nullptr, &dx_rtv );
}


/************************************************************************/
/*                                                                      */
/* COMMANDS                                                             */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* UNIT TESTS                                                           */
/*                                                                      */
/************************************************************************/
