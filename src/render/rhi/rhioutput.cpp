/************************************************************************/
/*                                                                      */
/* INCLUDE                                                              */
/*                                                                      */
/************************************************************************/
#include "rhioutput.h"

#include "render/rhi/rhidevicecontext.h"
#include "render/rhi/rhidevice.h"
#include "render/rhi/rhiinstance.h"
#include "render/rhi/texture2d.h"

/************************************************************************/
/*                                                                      */
/* DEFINES AND CONSTANTS                                                */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* MACROS                                                               */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* TYPES                                                                */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* STRUCTS                                                              */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* CLASSES                                                              */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* LOCAL VARIABLES                                                      */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* GLOBAL VARIABLES                                                     */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* LOCAL FUNCTIONS                                                      */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* EXTERNAL FUNCTIONS                                                   */
/*                                                                      */
/************************************************************************/

//------------------------------------------------------------------------
// RENDER OUTPUT
//------------------------------------------------------------------------

//------------------------------------------------------------------------
RHIOutput::RHIOutput( RHIDevice *owner, 
   IDXGISwapChain *sc,
   Window *wnd )
   : window(wnd)
   , swap_chain(sc)
{
   device = owner;
   create_render_target();
}

//------------------------------------------------------------------------
RHIOutput::~RHIOutput() 
{
   close();
}

//------------------------------------------------------------------------
void RHIOutput::present()
{
   swap_chain->Present( 1, // SyncInterval (VSync)
      0 ); // flags (see DXGI_PRESENT options in MSDN)
}

//------------------------------------------------------------------------
void RHIOutput::close()
{
   destroy_render_target();
   destroy_swap_chain();
   if (nullptr != window) {
      window->close();
      delete window;
      window = nullptr;
   }
}

//------------------------------------------------------------------------
void RHIOutput::destroy_render_target()
{
   if (nullptr != render_target) {
      delete render_target;
      render_target = nullptr;
   }
}

//------------------------------------------------------------------------
void RHIOutput::destroy_swap_chain()
{ 
   DX_SAFE_RELEASE(swap_chain);
}

//------------------------------------------------------------------------
bool RHIOutput::create_render_target()
{
   render_target = new Texture2D( device, this );
   return render_target->is_valid();
}


/************************************************************************/
/*                                                                      */
/* COMMANDS                                                             */
/*                                                                      */
/************************************************************************/

/************************************************************************/
/*                                                                      */
/* UNIT TESTS                                                           */
/*                                                                      */
/************************************************************************/
